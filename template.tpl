___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "inQuba Journey Tracker",
  "categories": ["ANALYTICS", "ATTRIBUTION", "PERSONALIZATION"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "InQuba",
    "thumbnail": "data:image/jpeg;base64,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jiL8FK9scHazcsca5lJBa5p2aWIxJSPUbAJcjSY8cseTa2F/CTaig5KVHDsMvdV1Pi0GuzT9lKDLtFfCewddbQsO8Vz9aC0WMAFBTbublPStH2GdOFBiJZ+zrwFnLvfzipTHLM5PAD7HsOdMuHeDza0AQEHoIvrUe6mDsgB5pcoIEY8F0+YjJT6/yPZqbecB5rGDy/0q/j93Kv3cc6SO4T4pTRq/0o8bZMfxb//aAAwDAQACAAMAAAAQMMMMMMMMMMMMM888z4x908888884ntx0/N888888iZn88eWB+888s2d8888s3I888v7c88888t6888vt8888889o888qmU888882T888s1T0888mGY0888ayK+wn1rfOU888P9y4+O88Nc888888888888888888888888888//EACcRAQABAgUEAgMBAQAAAAAAAAERADEhQVFxkSBhgaHB0RCx8EAw/9oACAEDAQE/EP8AAWNVyMaKlQ7wftKCmL/GtY4RrGHNv+JAr79mh34qFoa5+W9Nw57Y/qafjBv9FNkHsjyUchsWdz5PdOYQ4e5qdQoXztNjPik7wGAF10P7CmxpAt518/kmoMxhpkWLgfH7c607wzdo/TnQlwkJ0AzKsHmrKQxe+bzRscodtd2/rLqYNPuycW4ogfyCzxh46DWsK8CnukvZI5R+nrY+U15MPYUcy8HhPieggXM/SmSZP7db/wAAK+aQVkX7t0Daxi2cH01Adwxvc90jQhOpPLDKZTaaxmMhyxnDSdLdISmT8Hye5pzOtNHXZz779OQGBQk4ritVv4yO1Ezis/n9ONKRoQnQaxMk1NPqpUyrjc7J/TSwSc1vDltbam43wSck0jCHd9U8PeLuL8xUOEu6u/R2oJTs1x2GrrpvQZD3NnJ7PisGDoYPJfzNX6AE3wegLJensmdEk/qYnFz3RMo8g8MNDyA2fdAN/TF7t7o9GXl5y8c/keANJw4cKQGUle/+z//EACgRAQAAAwgDAQACAwAAAAAAAAEAETEgIUFRYXGBkaGx0cEQQDDh8P/aAAgBAgEBPxD+g4WQZwrIHab6GFpXOXyLoNZTv6r/AIV38g310icTow4KQLMS1u9ygad/k+xIjrUlCw+7U2fx8QemB8aOtphX8DPdw7g0E1quGrAZ1FXjL+XJEcG+DY7iv6PkHrxUZn0whqZhMsK6QTYryK40wIYpjLXLiloBOXice69w7/I2a+fdhmGIHaHqAooZ9X2yVjIOP9ThJHGZ2fbAVTB9oIHMfVsKJqpEAcSQeLCmVS7cvPUZFK/aj4gAUG0aIoGcouTsYxulfZeWY5+nHqUEnuVZmW5hpZlcBCtXBcMj7jCkmuw/489wAEmNhpxuTnEp0ko56jA4pDBXkx39wDPYLJ6ZQHMXD7BCaAU7p1OJnchQUPrrCU7CZ67e9oXSfMfd+4vlBk3nTTiKt4LyWLxQ9bOEPMgybnuj4hOQOFOyE5KdmFChnc8V8QmN6TjHnr+W5mucr+6wOUgSNv7n/8QAKhABAAECBAcBAAICAwAAAAAAAREAITFBUWEQMHGBkaGxIMHRQPBQYOH/2gAIAQEAAT8QgqCoKgqCoKgqCoKgqCoKgqCoKgqCoKgqCoKgqCoKg/5pYGE2k9DF7UgEOc/3R8p5Qoyf4il7K0rGg8zWPtFAK0DypfVChsSij1xHc/wV6vhXTTEalBMkoDrOHZfem37Krd39LeGUkbJVnBsrhbZ+/moxgnzno3Lc1Yo9sXEm4Q+s21N8C72DQMA2ODzPhZHQCgycF/bvSlbPiR5U+UYzcWPtIXKiR5F8rUzpsdUeBTjThNG48GaXMcn9m1Cvhwfg6bPGnMNsfNcwoPhnT8MNSjFXgc5Ny0Plu261Aldj3qw6EH5ikCOIA7NuVP8AuEsthg3PHB/IiUImCNR7lyohz6M9cdeU14kEl0wOr6mmDrswNA0AscJzzgztP0M+mINjQBAGhyECG5QuZg9jmeTqZ5b4US4qFwrAGSZJfs4nXkNNPVkKz5ui3ngatEBLYnQzdutC2AgBAHKSSKAWEls1+xi6ztwkZAFbf27HRov+2nAIHOFndgpXqw4qZX3T9xcWRgKCYhjMe68+g5goEZp0DcYe1QGKO6inKUSJk1G4mi/0JJ7/ALaFiDU5e+C6aZYQg90e3OGBng6r1wIvKZdDD79v3HbZQ6AfXAT+i4Ar6eOcMjNt3PvgNM3aNX+0/tkMiDhiGXA9ucghxGPLwQxgB6XfuAlsO6r8cCkrxfY5x1RdwXMWSzVhCwSVaiSc3Q/l/cpwc6Ex74TlcpM3h6aGHOdGYD9l+D2imcBbJmKGmFj+3wCR2x3iO9JDV1q9WAbnck70GYVM0Scwvab1gJWmR35gZtrEdzhB+0kSpTpIEElx0ZPHC1EFXxMf5Dvy1isHiLb/AMz4nWiNOTIMxKwePh1yNbfB2oiCI3Ez5GPQ4y5j2BbcKcsiFEI6UfFKMAZEoMuTAAf6plU8htTUUiS6+oe8KYcPEFeIQxzQdP4MTLSifXJif7p+4qbe0J2Jo56N8+BXDRJKiQgRZN9frphRhmkSRNf0AVQDNqNGlNL7jEaHdpX2Sz0aBocDY93t1ocmfqnru7eahZ9MThHeLLeWWaP/AMheTdaTy0KsAtyMJD+g8igSI5JTNWp85yjP3OlYcG0Bb+pMexKwmxXOvDCe6SiOQp4FaYa/+tQkUzR8GtKeh1M30UJu7HNFj3PFNCHZEabs8taPrgqAYAVcf2TZdTEd6E4LIFjf6HinaJCwjojyXEERqSkkKG3DFueKYSvCE7oWeQnE4ljcsA61HwC7N9fXWhIAIAIA/GEowRR0EPupcrlB0hPuhUAjJlMQck5xwO3Zq7g4xzqudmlglh8GB7qbjDMR7NI4jSh4I5xPimgKxfTT+0WDXfll3msEvQx1ti/9W//Z"
  },
  "description": "InQuba helps you discover and visualise your customers’ real journeys",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "inqubaEndpoint",
    "displayName": "inQuba Endpoint",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "help": "Enter the public endpoint for your inQuba account (e.g. https://inquba.example.com)",
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "(https:\\/\\/.)?(www\\.)?[-a-zA-Z0-9@:%._\\+~#\u003d]{2,256}\\.[a-z]{2,6}\\b([-a-zA-Z0-9@:%_\\+.~#?\u0026//\u003d]*)"
        ],
        "errorMessage": "A URL starting with \u0027https://\u0027 is required.",
        "enablingConditions": []
      },
      {
        "type": "NON_EMPTY",
        "errorMessage": "The inQuba Endpoint cannot be empty."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "eventDetails",
    "displayName": "Event Details",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "transactionCode",
        "displayName": "Transaction Code",
        "simpleValueType": true,
        "alwaysInSummary": true,
        "help": "Enter the co you want to associate with the event transactionde",
        "valueValidators": [
          {
            "type": "NON_EMPTY",
            "errorMessage": "A transaction code is always required."
          }
        ]
      },
      {
        "type": "LABEL",
        "name": "idLabel",
        "displayName": "Identifiers: use one or more of user ID, phone number or (hashed) email. Identifiers are only sent over https, if required, make sure to hash variables first."
      },
      {
        "type": "TEXT",
        "name": "endUserId",
        "displayName": "User ID",
        "simpleValueType": true,
        "alwaysInSummary": true
      },
      {
        "type": "TEXT",
        "name": "endUserPhone",
        "displayName": "User Phone",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "endUserEmail",
        "displayName": "User Email",
        "simpleValueType": true,
        "help": ""
      },
      {
        "type": "SELECT",
        "name": "persistentIdentifier",
        "displayName": "Anonymous (persistent) Identifier",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "autoGenerate",
            "displayValue": "Auto Generate"
          }
        ],
        "simpleValueType": true,
        "help": "Identify users with an existing identifier from a cookie or other variable. This ID will be resolved later when there is a known user identifier.",
        "notSetText": "None",
        "defaultValue": "autoGenerate"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "customAttributesGroup",
    "displayName": "Custom Attributes",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "LABEL",
        "name": "label1",
        "displayName": "Use up to 10 additional attributes as key-value pairs to send custom information along."
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "customAttributesTable",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Attribute Name",
            "name": "attributeName",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Attribute Value",
            "name": "attributeValue",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "valueValidators": []
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const getContainerVersion = require('getContainerVersion');
const encodeUri = require('encodeUri');
const encodeUriComponent = require('encodeUriComponent');
const sendPixel = require('sendPixel');
const sha256 = require('sha256');
const localStorage = require('localStorage');
const generateRandom = require('generateRandom');
const getTimestampMillis = require('getTimestampMillis');
const getUrl = require('getUrl');
const getReferrerUrl = require('getReferrerUrl');

const sourceName = "IQCVT_" + getContainerVersion().containerId;

// Helper functions

/*
Generate a random ID
*/
function randomId() {
  const randomPart = "xxxxxxxxxxxx".split('').map(function() {
    return generateRandom(0,9);
  }).join('');
 return getTimestampMillis() + "." + randomPart;
}

const endpoint = data.inqubaEndpoint;
let persistentId = data.persistentIdentifier === "None" ? undefined : data.persistentIdentifier;

if(persistentId === "autoGenerate") {
  if(localStorage.getItem('iqId')) {
    persistentId = localStorage.getItem('iqId');
  } else {
    const generatedId = randomId();
    localStorage.setItem('iqId', generatedId);
    persistentId = generatedId;
  }
}

// Set parameters to construct GET request
let params = 't=' + getTimestampMillis() + // timestamp
             '&tc=' + encodeUriComponent(data.transactionCode) + // transaction code
             '&dl=' + encodeUriComponent(getUrl()) +
             '&s=' + sourceName;

// Check for referrer URL
if(getReferrerUrl()) {
  params = params + '&dr=' + encodeUriComponent(getReferrerUrl());
}


// Get optional UTM campaign parameters from URL (usually only on landing page)
const URLQueryParams = getUrl('query') || ""; 

// Get utm_ URL parameters
const UTMQueryParams = URLQueryParams.split('&').filter(p => {
  return p.indexOf('utm_') > -1; 
});
if (UTMQueryParams.length > 0) {
  params = params + '&' + UTMQueryParams.join('&');
}

const contactIDQueryParam = URLQueryParams.split('&').filter(p => {
  return p.indexOf('contactid') > -1; 
});
if (contactIDQueryParam.length > 0) {
  params = params + '&' + contactIDQueryParam[0].replace('contactid','did');
}




// Set custom attribute parameters
let ca = data.customAttributesTable || [];
if(ca.length > 0) {
  ca = ca.filter(el => {
    // Only use rows with both attribute and value set
    return el.attributeName.length > 0 && el.attributeValue.length > 0;
  }).map((el, i) => {
    return "ca"+i+"_"+encodeUriComponent(el.attributeName)+"="+encodeUriComponent(el.attributeValue);
  });
  
  params = params + "&ca=" + ca.join("~");
}

// Add anonymous persistent ID to GET request params if available
if(persistentId) {
  params = params + '&aid=' + encodeUriComponent(persistentId);
}


// Add identifiers if present
const uid = data.endUserId ? ("&uid=" + encodeUriComponent(data.endUserId)) : "";
const ph = data.endUserPhone ? ("&ph=" + encodeUriComponent(data.endUserPhone)) : "";
const em = data.endUserEmail ? ("&em=" + encodeUriComponent(data.endUserEmail)) : "";
params = params + uid + ph + em;


return sendPixel(endpoint + '?' + params, data.gtmOnSuccess, data.gtmOnFailure);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_local_storage",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "iqId"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_referrer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Can Run with Minimal Data
  code: |-
    const mockData = {
      inqubaEndpoint : "https://www.example.com",
      transactionCode : "login",
      endUserId: "EndUserID"
    };

    // Call runCode to run the template's code.
    const codeResult = runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('sendPixel').wasCalled();
    assertThat(codeResult).contains(mockData.inqubaEndpoint);
    assertThat(codeResult).contains("tc="+mockData.transactionCode);
    assertThat(codeResult).contains("uid="+mockData.endUserId);
    assertApi('gtmOnSuccess').wasCalled();
- name: Persistent identifier is generated
  code: |-
    const mockData = {
      inqubaEndpoint : "https://www.example.com",
      transactionCode : "login",
      endUserId: "EndUserID",
      persistentIdentifier: "autoGenerate"
    };

    // Call runCode to run the template's code.
    const codeResult = runCode(mockData);

    // Asserts
    assertThat(codeResult).contains("aid=");
    assertApi('gtmOnSuccess').wasCalled();
- name: Values are URI encoded
  code: |-
    const mockData = {
      transactionCode : "SPACE IS THE PLACE",
      endUserId: "SPACE IS THE PLACE",
      endUserPhone: "SPACE IS THE PLACE",
      endUserEmail: "SPACE IS THE PLACE"
    };

    // Call runCode to run the template's code.
    const codeResult = runCode(mockData);

    // Asserts
    assertThat(codeResult).contains("tc=SPACE%20IS%20THE%20PLACE");
    assertThat(codeResult).contains("uid=SPACE%20IS%20THE%20PLACE");
    assertThat(codeResult).contains("ph=SPACE%20IS%20THE%20PLACE");
    assertThat(codeResult).contains("em=SPACE%20IS%20THE%20PLACE");
    assertApi('gtmOnSuccess').wasCalled();
- name: Custom Attributes are present in request and encoded
  code: |+
    const mockData = {
      inqubaEndpoint : "https://www.example.com",
      transactionCode : "login",
      endUserId: "EndUserID",
      customAttributesTable: [
        {
          attributeName: "CA NAME",
          attributeValue: "CA VALUE"
        }
      ]
    };

    // Call runCode to run the template's code.
    const codeResult = runCode(mockData);
    assertThat(codeResult).contains("ca=ca0_");
    assertThat(codeResult).contains("ca0_CA%20NAME=CA%20VALUE");
    assertApi('gtmOnSuccess').wasCalled();

setup: |-
  mock('sendPixel', function(url, onSuccess, onFailure) {
      onSuccess();
      return url;
  });


___NOTES___

Created on 31/03/2022, 10:29:17


